#!/bin/sh

. /home/engines/functions/checks.sh\r\n\r\nrequired_values=\"fqdn port proto parent_engine\"\r\ncheck_required_values\r\n\r\nres=`nslookup ${parent_engine}.engines.internal|grep -e \"Address: *[0-9]\" |awk '{print $2}'`\r\n `echo $res | grep -e \"[0-9].*\\.[0-9].*\\.[0-9].*\" >/dev/null`\r\n if test $? -ne 0\r\n  then  \t \r\n\techo '{\"status\":\"Error\",\"message\":\"failed to find internal dns entry for '${parent_engine}'.engines.internal\"}'\r\n\texit 127\r\n fi\r\n\t \r\ntemplate=\"/etc/nginx/templates/${proto}_site.tmpl\"\r\n\r\nresolv_ip=`nslookup control |grep -e \"Address: *[0-9]\" |awk '{print $2}'`\r\n\r\nservers=\"server SERVER.engines.internal:PORT;\"\r\ncnt=1\r\nif ! test -z $engine_count\r\n then\r\n \tif test $engine_count -gt 1\r\n \t then\r\n \t \twhile test $cnt -le  $engine_count\r\n \t \t\tdo\r\n \t \t\t    if test $cnt -ne 1\r\n \t \t\t\t  then\r\n \t \t\t\t\tn=$cnt \t \t   \r\n \t \t\t\t\tservers=\"$servers server SERVER$n.engines.internal:PORT;\"\r\n \t \t\t\tfi\r\n \t \t\t  cnt=`expr $cnt + 1 `\t\t\t\r\n \t \t\tdone \r\n \tfi\r\n fi\r\n \r\nif test $require_client_ssl = true\r\n then\r\n  ENABLE_SSLCA=\"\"\r\n  ssl_verify=on\r\n else\r\n  ssl_verify=off\r\n  ENABLE_SSLCA='#'\r\nfi\r\n\r\nif test -z $ca_name\r\n then\r\n   ca_file=system_CA.pem\r\n   crl_file=system_CA_CRL.pem\r\n else\r\n   ca_file=${ca_name}_CA.pem\r\n   crl_file=${ca_name}_CA_CRL.pem\r\nfi   \r\n  \r\ncat $template | sed \"/SERVERS/s//$servers/\" \\\r\n| sed \"/FQDN/s//$fqdn/g\" \\\r\n| sed \"/PORT/s//$port/g\"\\\r\n| sed \"/SERVER/s//$parent_engine/g\" \\\r\n| sed \"/ENABLE_SSLCA/s//$ENABLE_SSLCA/\" \\\r\n| sed \"/CA_FILE/s//$ca_file/\" \\\r\n| sed \"/SSLVERIFY/s//$ssl_verify/\"\\\r\n| sed \"/CRL_FILE/s//$crl_file/\" > /tmp/$fqdn.res\r\nwww_path=`echo $internal_dir  |sed \"s/^\\///\" |sed \"s/\\/$//\"`\r\n\r\n\r\nrewrite=\"\"\r\n   if ! test -z $www_path\r\n then\r\n    rewrite='rewrite \\^\\/'$www_path'\\/\\(\\.\\*\\) \\/'$www_path'\\/\\$1  break;\\\r\n        rewrite \\^\\/\\(\\.\\*\\) $fqdn\\/'$www_path'\\/\\$1  break; '\r\nfi\r\ncat /tmp/$fqdn.res | sed \"/FOLDER/s//$rewrite/\" >  /tmp/$fqdn.path\r\n\r\ndomain=`echo $fqdn  | cut -f2- -d.`\r\nif test \"$proto\" = default \r\n then\r\n    cp /tmp/site.name /etc/nginx/sites-enabled/default\r\n elif ! test \"$proto\" = http\r\n\t then\r\n\t \tif test -f /home/engines/etc/ssl/certs/${fqdn}.crt\r\n\t \t\tthen\r\n\t \t\t\tcert_name=${fqdn}\r\n\t \t\telif test -f /home/engines/etc/ssl/certs/${domain}.crt \r\n\t \t\t then\r\n\t \t\t \tcert_name=$domain\r\n\t \t\t elif test -f /home/engines/etc/ssl/certs/.${domain}.crt \r\n\t \t\t then\r\n\t \t\t \tcert_name=.$domain\t\r\n\t        else\r\n\t        cert_name=wap\r\n\t     fi\r\n\t\tif test -f /etc/nginx/sites-enabled/http_https_${fqdn}.site\r\n\t     \t\tthen\r\n\t     \t\t\trm -f /etc/nginx/sites-enabled/http_https_${fqdn}.site\r\n\t     \tfi\r\n\t\tif test -f /etc/nginx/sites-enabled/https_${fqdn}.site\r\n\t     \t\tthen\r\n\t     \t\t\trm -f /etc/nginx/sites-enabled/https_${fqdn}.site\r\n\t     \tfi\r\n\t     \tif test -f /etc/nginx/sites-enabled/http_${fqdn}.site\r\n\t     \t\tthen\r\n\t     \t\t\trm -f /etc/nginx/sites-enabled/http_${fqdn}.site\r\n\t     \tfi\r\n\t    cat /tmp/${fqdn}.path  | sed \"/CERTNAME/s//$cert_name/\" > /etc/nginx/sites-enabled/${proto}_${fqdn}.site\r\n\t else  #Proto is http\r\n\t\tif test -f /etc/nginx/sites-enabled/http_${fqdn}.site\r\n\t     \t\tthen\r\n\t     \t\t\trm -f /etc/nginx/sites-enabled/http_${fqdn}.site\r\n\t     \tfi\r\n\t\tif test -f /etc/nginx/sites-enabled/http_https_${fqdn}.site\r\n\t     \t\tthen\r\n\t     \t\t\trm -f /etc/nginx/sites-enabled/http_https_${fqdn}.site\r\n\t     \tfi\r\n\t\tif test -f /etc/nginx/sites-enabled/https_${fqdn}.site\r\n\t     \t\tthen\r\n\t     \t\t\trm -f /etc/nginx/sites-enabled/https_${fqdn}.site\r\n\t     \tfi\r\n\t \tcp /tmp/$fqdn.path /etc/nginx/sites-enabled/${proto}_${fqdn}.site\r\nfi\r\n\r\nmkdir -p /tmp/last_run\r\ncp \t/tmp/* /tmp/last_run\r\n\r\nrm /tmp/*\r\n\r\n\t if ! test -d /var/log/nginx/$fqdn/https/\r\n\t \tthen\r\n\t \t\tmkdir -p /var/log/nginx/$fqdn/https/\r\n\t \tfi\r\n \tif ! test -d /var/log/nginx/$fqdn/http/\r\n \tthen\r\n \t\tmkdir -p /var/log/nginx/$fqdn/http/\r\n \tfi\r\n nginx -s reload\t\r\n\t \r\necho '{\"status\":\"Sucess\"}'\r\nexit 0
